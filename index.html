<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body { margin:0; padding:0; height:100%; font-family:"Georgia", sans-serif; background:#1e1b2d; color:#dcd6f7; display:flex; }
  #sidebar { width:220px; background:#2b2244; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; overflow-y:auto; }
  #main { flex:1; display:flex; flex-direction:column; }
  header { padding:10px; background:#4b3b77; display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
  #username { width:100px; padding:6px; border-radius:4px; border:none; background:#6658a8; color:#fff; }
  #roomSelect { margin-top:10px; }
  #chat { flex:1; overflow-y:auto; padding:10px; }
  .msg { margin-bottom:10px; padding:8px; border-radius:6px; background:#3a2e66; max-width:80%; word-wrap:break-word; color:#fff; }
  .me { background:#5a7fff; margin-left:auto; text-align:right; }
  .meta { font-size:0.7rem; opacity:0.7; margin-bottom:2px; }
  #form { display:flex; padding:8px; background:#4b3b77; gap:5px; }
  #message { flex:1; padding:8px; border-radius:4px; border:none; background:#2b2244; color:#fff; }
  #send, #clearChat { padding:8px; border:none; border-radius:4px; background:#7fa1ff; color:#111b33; cursor:pointer; }
  #onlineUsers { margin-top:10px; font-size:0.9rem; }
  .userEntry { display:flex; justify-content:space-between; margin-bottom:4px; align-items:center; }
  .avatar { width:24px; height:24px; border-radius:50%; margin-right:6px; }
  .inviteBtn { background:#b49fff; padding:2px 5px; border:none; border-radius:3px; font-size:0.7rem; cursor:pointer; }
  @media(max-width:600px){ #sidebar{width:150px; font-size:0.9rem;} #message{font-size:0.9rem;} header{font-size:0.9rem;} }
</style>
</head>
<body>
<div id="sidebar">
  <input id="username" placeholder="Username">
  <select id="roomSelect">
    <option value="general">General Room</option>
  </select>
  <button id="createPrivate">Create Private Room</button>
  <div id="onlineUsers"><strong>Online:</strong></div>
</div>
<div id="main">
  <header>
    <div>Live Chat</div>
    <button id="clearChat">Clear</button>
  </header>
  <div id="chat"></div>
  <form id="form">
    <input id="message" autocomplete="off" placeholder="Type a message...">
    <button id="send" type="submit">Send</button>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
    projectId: "YOUR_FIREBASE_PROJECT_ID",
    storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
    messagingSenderId: "YOUR_FIREBASE_MESSAGING_ID",
    appId: "YOUR_FIREBASE_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Session ID for this device/tab
  const sessionId = Math.random().toString(36).substring(2,10);

  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const userInput = document.getElementById("username");
  const roomSelect = document.getElementById("roomSelect");
  const clearBtn = document.getElementById("clearChat");
  const onlineUsersEl = document.getElementById("onlineUsers");
  const createPrivateBtn = document.getElementById("createPrivate");

  let currentRoom = 'general';
  let typingTimeout;
  const onlineUsers = {};

  function addMessage(msg){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (msg.sessionId===sessionId?" me":"");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = msg.name + " â€¢ " + new Date(msg.time).toLocaleTimeString();
    const text = document.createElement("div");
    text.className = "text";
    text.textContent = msg.text;
    wrap.appendChild(meta);
    wrap.appendChild(text);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function updateOnlineUsers(){
    onlineUsersEl.innerHTML = "<strong>Online:</strong><br>";
    Object.values(onlineUsers).forEach(user=>{
      const entry = document.createElement("div");
      entry.className="userEntry";
      const nameSpan = document.createElement("span");
      nameSpan.textContent=user.name;
      const inviteBtn = document.createElement("button");
      inviteBtn.className="inviteBtn";
      inviteBtn.textContent="Invite";
      inviteBtn.onclick = ()=>alert("Invite "+user.name+" to room: "+currentRoom);
      entry.appendChild(nameSpan);
      entry.appendChild(inviteBtn);
      onlineUsersEl.appendChild(entry);
    });
  }

  // Listen for messages and online users
  db.collection("messages").orderBy("time").onSnapshot(snapshot=>{
    chatEl.innerHTML="";
    snapshot.forEach(doc=>{
      const msg = doc.data();
      if(msg.room===currentRoom) addMessage(msg);
    });
  });

  db.collection("online").onSnapshot(snapshot=>{
    snapshot.forEach(doc=>{
      const user = doc.data();
      if(user.room===currentRoom) onlineUsers[user.sessionId] = user;
    });
    updateOnlineUsers();
  });

  // Send message
  formEl.addEventListener("submit", e=>{
    e.preventDefault();
    const text = msgInput.value.trim();
    if(!text) return;
    const msg = {name:userInput.value.trim()||"anon", text, time:Date.now(), sessionId, room:currentRoom};
    db.collection("messages").add(msg);
    msgInput.value="";
  });

  // Clear chat (local only)
  clearBtn.addEventListener("click", ()=>{
    chatEl.innerHTML="";
  });

  // Update online status every 5s
  function updatePresence(){
    db.collection("online").doc(sessionId).set({name:userInput.value||"anon", sessionId, room:currentRoom});
    setTimeout(updatePresence,5000);
  }
  updatePresence();

  // Create private room
  createPrivateBtn.addEventListener("click", ()=>{
    const roomName = prompt("Enter private room name:");
    if(!roomName) return;
    roomSelect.innerHTML += `<option value="${roomName}">${roomName}</option>`;
    roomSelect.value = roomName;
    currentRoom = roomName;
  });

  // Switch rooms
  roomSelect.addEventListener("change", ()=>{
    currentRoom = roomSelect.value;
  });

</script>
</body>
</html>