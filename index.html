<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Live ðŸ”¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* ========== GENERAL STYLES ========== */
  html, body {
    margin:0; padding:0; height:100%;
    font-family:"Georgia", sans-serif;
    background:#1e1b2d; color:#dcd6f7;
    display:flex; flex-direction:column;
  }
  header {
    padding:10px 16px; background:#4b3b77;
    display:flex; justify-content:space-between; align-items:center;
  }
  #username, #roomName, #roomPass, #message {
    border-radius:6px; border:1px solid #6658a8;
    padding:8px; background:#2b2244; color:#e0d9ff;
    font-size:1rem;
  }
  #chat { flex:1; overflow-y:auto; padding:12px; }
  .msg { margin-bottom:10px; padding:6px 10px; border-radius:6px; background:#3a2e66; max-width:80%; word-wrap:break-word; display:flex; gap:6px; align-items:flex-start; }
  .me { background:#5a7fff; margin-left:auto; text-align:right; color:#fff; }
  .meta { font-size:0.7rem; opacity:0.7; }
  .text { font-size:0.95rem; }
  #form { display:flex; gap:6px; padding:10px; background:#4b3b77; }
  #send, #clearBtn { background:#7fa1ff; color:#111b33; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  #send:disabled { opacity:0.5; cursor:default; }
  #usersList { background:#2b2244; padding:6px; border-radius:6px; font-size:0.85rem; max-height:120px; overflow-y:auto; margin-top:6px; }
  #roomsDropdown { margin-left:6px; padding:6px; border-radius:6px; }
  .typingIndicator { font-size:0.8rem; opacity:0.6; margin-bottom:6px; }
  .avatar { width:30px; height:30px; border-radius:50%; object-fit:cover; }
</style>
</head>
<body>

<header>
  <div>
    <input id="username" placeholder="Your name">
    <input id="avatarInput" type="file" accept="image/*" style="display:none;">
    <button id="avatarBtn">Choose Avatar</button>
  </div>
  <div>
    <select id="roomsDropdown">
      <option value="general">General Room</option>
    </select>
    <input id="roomName" placeholder="Private Room Name">
    <input id="roomPass" placeholder="Room Password">
    <button id="createRoomBtn">Create/Join Room</button>
  </div>
</header>

<div id="usersList">Online Users:</div>
<div id="chat"></div>
<div class="typingIndicator" id="typingIndicator"></div>

<form id="form">
  <input id="message" autocomplete="off" placeholder="Type a message...">
  <button id="send" type="submit">Send</button>
  <button id="clearBtn" type="button">Clear Chat</button>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f",
  measurementId: "G-L0K72L8894"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= VARIABLES ================= */
const chatEl = document.getElementById("chat");
const formEl = document.getElementById("form");
const msgInput = document.getElementById("message");
const usernameInput = document.getElementById("username");
const sendBtn = document.getElementById("send");
const clearBtn = document.getElementById("clearBtn");
const usersList = document.getElementById("usersList");
const typingIndicator = document.getElementById("typingIndicator");
const roomsDropdown = document.getElementById("roomsDropdown");
const roomNameInput = document.getElementById("roomName");
const roomPassInput = document.getElementById("roomPass");
const createRoomBtn = document.getElementById("createRoomBtn");
const avatarBtn = document.getElementById("avatarBtn");
const avatarInput = document.getElementById("avatarInput");

let messages = [];
let typingTimeout;
let currentRoom = "general";
let myAvatar = "";
const KICK_PASSWORD = "slay"; // universal kick password

/* ================= AVATAR PICKER ================= */
avatarBtn.onclick = () => avatarInput.click();
avatarInput.onchange = e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => { myAvatar = reader.result; }
    reader.readAsDataURL(file);
  }
}

/* ================= CHAT FUNCTIONS ================= */
function addMessage(msg, isMe){
  const wrap = document.createElement("div");
  wrap.className = "msg" + (isMe ? " me" : "");
  const avatarEl = document.createElement("img");
  avatarEl.className = "avatar";
  avatarEl.src = msg.avatar || "https://i.imgur.com/4AiXzf8.png"; // default avatar
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = msg.name + " â€¢ " + new Date(msg.time).toLocaleTimeString();
  const text = document.createElement("div");
  text.className = "text";
  if(msg.image) text.innerHTML = `<img src="${msg.image}" style="max-width:100px;border-radius:6px;"><br>${msg.text}`;
  else text.textContent = msg.text;
  wrap.appendChild(avatarEl);
  wrap.appendChild(meta);
  wrap.appendChild(text);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function updateUsersList(users){
  usersList.innerHTML = "Online Users:<br>" + users.map(u=>`<img class="avatar" src="${u.avatar||'https://i.imgur.com/4AiXzf8.png'}"> ${u.name}`).join("<br>");
}

/* ================= FIREBASE ROOM FUNCTIONS ================= */
let onlineUsersRef = db.collection("rooms").doc(currentRoom).collection("users");

function joinRoom(room){
  currentRoom = room;
  chatEl.innerHTML = "";
  // Add self to online users
  const userDoc = onlineUsersRef.doc(usernameInput.value.trim()||"anon");
  userDoc.set({name: usernameInput.value.trim()||"anon", avatar: myAvatar});
  
  // Listen for messages
  db.collection("rooms").doc(currentRoom).collection("messages").orderBy("time")
    .onSnapshot(snapshot=>{
      chatEl.innerHTML="";
      snapshot.forEach(doc=>{
        const msg = doc.data();
        addMessage(msg, msg.name === (usernameInput.value.trim()||"anon"));
      });
    });
  
  // Listen for online users
  db.collection("rooms").doc(currentRoom).collection("users")
    .onSnapshot(snapshot=>{
      let users=[];
      snapshot.forEach(doc=>users.push(doc.data()));
      updateUsersList(users);
    });
}

joinRoom("general");

/* ================= SEND MESSAGE ================= */
formEl.addEventListener("submit", e=>{
  e.preventDefault();
  const text = msgInput.value.trim();
  if(!text) return;
  const msg = {
    name: usernameInput.value.trim()||"anon",
    text,
    time: Date.now(),
    avatar: myAvatar
  };
  db.collection("rooms").doc(currentRoom).collection("messages").add(msg);
  msgInput.value="";
});

/* ================= CLEAR CHAT (LOCAL ONLY) ================= */
clearBtn.onclick = ()=>{ chatEl.innerHTML=""; }

/* ================= CREATE / JOIN PRIVATE ROOM ================= */
createRoomBtn.onclick = ()=>{
  let room = roomNameInput.value.trim();
  let pass = roomPassInput.value.trim();
  if(!room) return alert("Enter room name");
  db.collection("rooms").doc(room).set({joinPassword:pass || "", adminPassword:KICK_PASSWORD});
  if(!Array.from(roomsDropdown.options).some(o=>o.value===room)){
    let opt = document.createElement("option"); opt.value=room; opt.text=room;
    roomsDropdown.appendChild(opt);
  }
  roomsDropdown.value = room;
  joinRoom(room);
  roomNameInput.value=""; roomPassInput.value="";
}

/* ================= SWITCH ROOM ================= */
roomsDropdown.onchange = ()=> joinRoom(roomsDropdown.value);

/* ================= KICK FUNCTION ================= */
function kickUser(username){
  const pw = prompt("Enter kick password:");
  if(pw !== KICK_PASSWORD) return alert("Wrong password");
  db.collection("rooms").doc(currentRoom).collection("users").doc(username).delete();
  alert(username + " has been kicked!");
}

/* ================= TYPING INDICATOR ================= */
msgInput.addEventListener("input", ()=>{
  typingIndicator.textContent = (usernameInput.value.trim()||"anon")+" is typing...";
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ typingIndicator.textContent=""; }, 1000);
});

/* ================= IMAGE UPLOAD ================= */
msgInput.addEventListener("paste", e=>{
  const items = e.clipboardData.items;
  for(let i=0;i<items.length;i++){
    if(items[i].type.indexOf("image")!==-1){
      const blob = items[i].getAsFile();
      const reader = new FileReader();
      reader.onload = ()=> {
        const msg = {
          name: usernameInput.value.trim()||"anon",
          text:"",
          time: Date.now(),
          avatar: myAvatar,
          image: reader.result
        };
        db.collection("rooms").doc(currentRoom).collection("messages").add(msg);
      }
      reader.readAsDataURL(blob);
    }
  }
});

/* ================= VOICE CHAT ================= */
let localStream;
let peers = {};
const constraints = {audio:true};

navigator.mediaDevices.getUserMedia(constraints)
.then(stream=>{
  localStream = stream;
})
.catch(err=>console.log("Microphone access denied"));

async function createPeerConnection(remoteId){
  const pc = new RTCPeerConnection();
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  pc.ontrack = e=>{
    let audio = document.getElementById("audio-"+remoteId);
    if(!audio){
      audio = document.createElement("audio"); audio.id="audio-"+remoteId; audio.autoplay=true;
      document.body.appendChild(audio);
    }
    audio.srcObject = e.streams[0];
  }
  return pc;
}

/* ================= END OF SCRIPT ================= */
</script>
</body>
</html>