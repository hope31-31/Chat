<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body {
    margin:0; padding:0; height:100%;
    font-family: "Georgia", sans-serif;
    background:#cce0ff; /* calming blue */
    color:#001f4d;
    display:flex;
    flex-direction:column;
  }
  header {
    padding:12px 16px;
    background:#99c2ff;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  #username, #avatarInput, #roomName, #roomPass {
    padding:6px; border-radius:4px; border:1px solid #66a3ff;
    font-size:1rem;
  }
  #chat {
    flex:1;
    overflow-y:auto;
    padding:10px;
    border-top:2px solid #66a3ff;
    border-bottom:2px solid #66a3ff;
  }
  .msg { margin-bottom:10px; padding:6px 10px; border-radius:6px; background:#99c2ff; max-width:80%; word-wrap:break-word; }
  .me { background:#66a3ff; margin-left:auto; color:white; }
  .meta { font-size:0.75rem; opacity:0.7; margin-bottom:2px; }
  .text { font-size:1rem; }
  #form { display:flex; padding:10px; gap:6px; }
  #message { flex:1; padding:8px; border-radius:4px; border:1px solid #66a3ff; }
  button { padding:8px 12px; border:none; border-radius:4px; background:#004080; color:white; font-weight:bold; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:default; }
  #sidebar { position:fixed; top:0; right:0; width:200px; height:100%; background:#cce0ff; border-left:2px solid #66a3ff; padding:10px; overflow-y:auto; }
  #onlineUsers { margin-bottom:10px; }
  .typing { font-style:italic; opacity:0.6; }
  .roomButton { display:block; margin:4px 0; width:100%; text-align:left; }
  @media(max-width:600px){
    #sidebar { width:140px; font-size:0.8rem; }
    #username,#avatarInput,#roomName,#roomPass,#message { font-size:0.85rem; }
  }
</style>
</head>
<body>
<header>
  <div>
    Username: <input id="username" placeholder="you">
    Avatar: <input type="file" id="avatarInput" accept="image/*">
  </div>
  <div>
    <input id="roomName" placeholder="Room name">
    <input id="roomPass" placeholder="Password (private)">
    <button id="joinRoom">Join/Create Room</button>
  </div>
</header>

<div id="chat"></div>
<form id="form">
  <input id="message" autocomplete="off" placeholder="Type a message...">
  <button id="send" type="submit">Send</button>
  <button type="button" id="clearChat">Clear Chat</button>
</form>

<div id="sidebar">
  <h4>Online Users</h4>
  <div id="onlineUsers"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
    projectId: "YOUR_FIREBASE_PROJECT_ID",
    storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
    messagingSenderId: "YOUR_FIREBASE_MESSAGING_ID",
    appId: "YOUR_FIREBASE_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const usernameInput = document.getElementById("username");
  const avatarInput = document.getElementById("avatarInput");
  const clearBtn = document.getElementById("clearChat");
  const joinRoomBtn = document.getElementById("joinRoom");
  const roomNameInput = document.getElementById("roomName");
  const roomPassInput = document.getElementById("roomPass");
  const onlineUsersEl = document.getElementById("onlineUsers");

  let currentRoom = "General";
  let user = {name:"anon", avatar:"https://via.placeholder.com/50", typing:false};
  let kickPassword = "slay";

  // Load avatar if uploaded
  avatarInput.addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const ref = storage.ref("avatars/"+Date.now()+"_"+file.name);
    await ref.put(file);
    user.avatar = await ref.getDownloadURL();
  });

  // Join/Create Room
  joinRoomBtn.addEventListener("click", ()=>{
    currentRoom = roomNameInput.value || "General";
    listenMessages();
    listenUsers();
    chatEl.innerHTML = "";
  });

  // Add message to chat
  function addMessage(msg, isMe){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (isMe?" me":"");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<img src="${msg.avatar}" width="20" height="20"> ${msg.name}`;
    const text = document.createElement("div");
    text.className = "text";
    text.textContent = msg.text;
    wrap.appendChild(meta);
    wrap.appendChild(text);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // Clear chat locally
  clearBtn.addEventListener("click", ()=>{ chatEl.innerHTML=""; });

  // Typing indicator
  msgInput.addEventListener("input", ()=>{
    db.collection("rooms").doc(currentRoom).collection("typing").doc(user.name).set({typing:true});
    setTimeout(()=>{ db.collection("rooms").doc(currentRoom).collection("typing").doc(user.name).delete(); }, 1000);
  });

  // Send message
  formEl.addEventListener("submit", e=>{
    e.preventDefault();
    if(!msgInput.value.trim()) return;
    db.collection("rooms").doc(currentRoom).collection("messages").add({
      name:user.name||usernameInput.value||"anon",
      text: msgInput.value,
      avatar: user.avatar,
      time: Date.now()
    });
    msgInput.value="";
  });

  // Listen to messages
  function listenMessages(){
    db.collection("rooms").doc(currentRoom).collection("messages").orderBy("time")
      .onSnapshot(snapshot=>{
        chatEl.innerHTML="";
        snapshot.forEach(doc=>{
          const msg = doc.data();
          addMessage(msg, msg.name===user.name);
        });
      });
  }

  // Online users
  function listenUsers(){
    const onlineRef = db.collection("rooms").doc(currentRoom).collection("online");
    const userDoc = onlineRef.doc(user.name);
    userDoc.set({avatar:user.avatar, joined:Date.now()});
    userDoc.onSnapshot(()=>{
      onlineRef.get().then(snap=>{
        onlineUsersEl.innerHTML="";
        snap.forEach(doc=>{
          const u = doc.data();
          const div = document.createElement("div");
          div.innerHTML = `<img src="${u.avatar}" width="20" height="20"> ${doc.id}`;
          onlineUsersEl.appendChild(div);
        });
      });
    });
    // Remove on disconnect
    window.addEventListener("beforeunload", ()=>{ userDoc.delete(); });
  }

  // Kick user
  function kickUser(targetName){
    const pw = prompt("Kick password:");
    if(pw!==kickPassword) return alert("Wrong password");
    db.collection("rooms").doc(currentRoom).collection("messages").add({
      name:"SYSTEM",
      text:`${targetName} was kicked to Timeout Room.`,
      avatar:"",
      time:Date.now()
    });
  }

  // Initialize user
  user.name = usernameInput.value || "anon";
  listenMessages();
  listenUsers();
</script>
</body>
</html>