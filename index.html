<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Chat with Reactions</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#f2f2f2; }
button { cursor:pointer; }

/* --- LOGIN --- */
#login-screen { display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; }
#login-screen input { padding:10px; margin:5px; width:80%; max-width:250px; font-size:16px; }
#login-screen button { padding:10px 20px; margin:5px; }

/* --- CHAT --- */
#chat-screen { display:flex; height:100vh; }

/* Sidebar */
#sidebar { width:250px; background:#fff; border-right:1px solid #ccc; display:flex; flex-direction:column; }
#sidebar h3 { text-align:center; padding:10px 0; margin:0; background:#007bff; color:#fff; }
#rooms, #users { flex:1; overflow-y:auto; padding:10px; }
#rooms .room { padding:8px; cursor:pointer; border-radius:10px; margin:5px 0; transition:0.2s; }
#rooms .room.selected { background:#007bff; color:#fff; font-weight:bold; }
#rooms .room:hover { background:#007bff33; }
#users .user { display:flex; align-items:center; padding:5px; border-radius:10px; margin:3px 0; background:#eee; position:relative; }
.avatar { width:35px; height:35px; background:#007bff; color:#fff; border-radius:50%; text-align:center; line-height:35px; margin-right:10px; font-weight:bold; }
.online-dot { width:10px; height:10px; background:green; border-radius:50%; position:absolute; top:5px; right:5px; border:2px solid #fff; }

/* Main chat */
#main { flex:1; display:flex; flex-direction:column; position:relative; }
#chat { flex:1; padding:15px; overflow-y:auto; background:#f9f9f9; display:flex; flex-direction:column; }
.msg { padding:10px 15px; margin:5px 0; border-radius:20px; max-width:70%; word-wrap:break-word; display:inline-block; clear:both; position:relative; }
.me { background:#007bff; color:#fff; align-self:flex-end; border-bottom-right-radius:0; }
.other { background:#e0e0e0; color:#000; align-self:flex-start; border-bottom-left-radius:0; }
.msg img { max-width:100%; border-radius:15px; margin-top:5px; }
.meta { font-size:12px; margin-bottom:3px; opacity:0.7; }

/* Reactions */
.reactions { display:flex; margin-top:5px; }
.reaction { padding:2px 6px; margin-right:5px; background:#eee; border-radius:12px; cursor:pointer; user-select:none; transition:0.2s; font-size:14px; }
.reaction:hover { background:#ddd; }

/* Typing bubble */
#typing { margin:5px 15px; align-self:flex-start; font-style:italic; color:#555; }
.typing-bubble { background:#e0e0e0; border-radius:20px; padding:8px 12px; display:inline-block; margin:3px 0; animation: blink 1s infinite; }
@keyframes blink { 0%, 50%, 100% { opacity:1; } 25%, 75% { opacity:0.5; } }

/* Input */
#form { display:flex; padding:10px; background:#fff; border-top:1px solid #ccc; }
#msg { flex:1; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:20px; }
#form button { padding:10px 20px; margin-left:10px; border:none; background:#007bff; color:#fff; border-radius:20px; }
#img-file { margin-left:10px; }

/* Bottom controls */
#controls { display:flex; padding:10px; background:#fff; border-top:1px solid #ccc; justify-content:space-between; flex-wrap:wrap; }
#controls input { padding:5px 10px; margin:2px; }
#controls button { padding:5px 10px; margin:2px; border:none; background:#007bff; color:#fff; border-radius:5px; }

/* --- RESPONSIVE --- */
@media (max-width: 768px) {
  #chat-screen { flex-direction:column; }
  #sidebar { width:100%; height:auto; border-right:none; border-bottom:1px solid #ccc; display:flex; flex-direction:row; flex-wrap:wrap; }
  #rooms, #users { flex:1 1 50%; max-height:120px; overflow-y:auto; }
  #main { flex:1; height:auto; }
  #chat { max-height:300px; }
}
@media (max-width: 480px) {
  #form, #controls { flex-direction:column; }
  #form button, #controls button { margin:5px 0; width:100%; }
  #form input, #controls input { width:100%; margin-bottom:5px; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <h2>Login or Sign Up</h2>
  <input type="text" id="login-username" placeholder="Username" />
  <button id="login-btn">Login / Sign Up</button>
  <p id="login-msg" style="color:red;"></p>
</div>

<!-- CHAT -->
<div id="chat-screen">
  <!-- Sidebar -->
  <div id="sidebar">
    <h3>Rooms</h3>
    <div id="rooms"></div>
    <input type="text" id="new-room" placeholder="New room"/>
    <input type="text" id="new-room-pass" placeholder="Password"/>
    <button id="create-room">Create</button>

    <h3>Online Users</h3>
    <div id="users"></div>
  </div>

  <!-- Main chat -->
  <div id="main">
    <div id="chat"></div>
    <div id="typing"></div>
    <form id="form">
      <input type="text" id="msg" placeholder="Type a message..." autocomplete="off"/>
      <input type="file" id="img-file" accept="image/*"/>
      <button>Send</button>
    </form>
    <div id="controls">
      <button id="clear-btn">Clear Chat</button>
      <button id="invite-btn">Copy Invite Link</button>
      <input type="text" id="change-username" placeholder="New Username"/>
      <button id="change-btn">Change Username</button>
    </div>
  </div>
</div>

<script>
// Firebase
firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});
const db = firebase.firestore();
const storage = firebase.storage();
const serverTime = firebase.firestore.FieldValue.serverTimestamp;

let username;
let onlineRef;
let currentRoom = "General";
let rooms = {};
let unsubscribeMessages = null;

// Elements
const loginScreen = document.getElementById("login-screen");
const loginInput = document.getElementById("login-username");
const loginBtn = document.getElementById("login-btn");
const loginMsg = document.getElementById("login-msg");
const chatScreen = document.getElementById("chat-screen");
const roomsEl = document.getElementById("rooms");
const usersEl = document.getElementById("users");
const chatEl = document.getElementById("chat");
const typingEl = document.getElementById("typing");
const form = document.getElementById("form");
const msgInput = document.getElementById("msg");
const imgInput = document.getElementById("img-file");
const newRoomInput = document.getElementById("new-room");
const newRoomPass = document.getElementById("new-room-pass");
const createRoomBtn = document.getElementById("create-room");
const clearBtn = document.getElementById("clear-btn");
const inviteBtn = document.getElementById("invite-btn");
const changeInput = document.getElementById("change-username");
const changeBtn = document.getElementById("change-btn");

// --- LOGIN ---
loginBtn.onclick = async () => {
  const name = loginInput.value.trim();
  if (name.length<2) return loginMsg.textContent="Username must be 2+ letters.";
  const userDoc = db.collection("users").doc(name);
  const doc = await userDoc.get();
  if(!doc.exists) await userDoc.set({ createdAt: serverTime });

  username=name;
  localStorage.setItem("username",username);

  onlineRef=db.collection("online").doc(username);
  onlineRef.set({name:username,room:currentRoom});
  window.addEventListener("beforeunload",()=>onlineRef.delete());

  loginScreen.style.display="none";
  chatScreen.style.display="flex";

  ensureGeneralRoom();
  loadRooms();
  joinRoom(currentRoom);
  listenOnlineUsers();
  listenTyping();
};

// --- ENSURE GENERAL ROOM ---
function ensureGeneralRoom(){ db.collection("rooms").doc("General").get().then(d=>{ if(!d.exists) db.collection("rooms").doc("General").set({name:"General",password:""}); }); }

// --- LOAD ROOMS ---
function loadRooms(){
  db.collection("rooms").onSnapshot(snap=>{
    roomsEl.innerHTML="";
    rooms={};
    snap.forEach(d=>{
      const data=d.data();
      rooms[data.name]=data.password||"";
      const div=document.createElement("div");
      div.className="room "+(data.name===currentRoom?"selected":"");
      div.textContent=data.name;
      div.onclick=()=>joinRoom(data.name);
      roomsEl.appendChild(div);
    });
  });
}

// --- JOIN ROOM ---
function joinRoom(room){
  const pass=rooms[room];
  if(pass && pass!==""){
    const entered=prompt("Enter password for "+room);
    if(entered!==pass) return alert("Wrong password");
  }
  currentRoom=room;
  onlineRef?.update({room:currentRoom});
  listenMessages();
}

// --- LISTEN MESSAGES & REACTIONS ---
function listenMessages(){
  if(unsubscribeMessages) unsubscribeMessages();
  chatEl.innerHTML="";
  unsubscribeMessages=db.collection("messages")
    .where("room","==",currentRoom)
    .orderBy("time")
    .onSnapshot(snapshot=>{
      chatEl.innerHTML="";
      snapshot.forEach(d=>{
        const m=d.data();
        const id=d.id;
        const div=document.createElement("div");
        div.className="msg "+(m.user===username?"me":"other");
        div.innerHTML=`<div class="meta">${m.user}</div>`+
                      (m.text?m.text:'')+
                      (m.image?`<img src="${m.image}">`:'');
        chatEl.appendChild(div);

        // --- REACTIONS ---
        const reactDiv=document.createElement("div");
        reactDiv.className="reactions";
        const emojis=["â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ‘"];
        emojis.forEach(emoji=>{
          const count=(m.reactions && m.reactions[emoji])?m.reactions[emoji].length:0;
          const btn=document.createElement("div");
          btn.className="reaction";
          btn.textContent=emoji+(count?` ${count}`:'');
          btn.onclick=async ()=>{
            const msgRef=db.collection("messages").doc(id);
            const doc=await msgRef.get();
            const data=doc.data();
            if(!data.reactions) data.reactions={};
            if(!data.reactions[emoji]) data.reactions[emoji]=[];
            if(data.reactions[emoji].includes(username)){
              data.reactions[emoji]=data.reactions[emoji].filter(u=>u!==username);
            }else{
              data.reactions[emoji].push(username);
            }
            msgRef.update({reactions:data.reactions});
          };
          reactDiv.appendChild(btn);
        });
        div.appendChild(reactDiv);
      });
      chatEl.scrollTop=chatEl.scrollHeight;
    });
}

// --- SEND TEXT ---
form.onsubmit=e=>{
  e.preventDefault();
  const text=msgInput.value.trim();
  if(!text) return;
  db.collection("messages").add({user:username,text,room:currentRoom,time:serverTime});
  msgInput.value="";
};

// --- SEND IMAGE ---
imgInput.onchange=async ()=>{
  const file=imgInput.files[0];
  if(!file) return;
  const fileRef=storage.ref().child('images/'+Date.now()+'-'+file.name);
  await fileRef.put(file);
  const url=await fileRef.getDownloadURL();
  db.collection("messages").add({user:username,image:url,room:currentRoom,time:serverTime});
  imgInput.value="";
};

// --- CREATE ROOM ---
createRoomBtn.onclick=()=>{
  const r=newRoomInput.value.trim();
  if(!r) return;
  db.collection("rooms").doc(r).set({name:r,password:newRoomPass.value.trim()});
  newRoomInput.value="";
  newRoomPass.value="";
};

// --- ONLINE USERS ---
function listenOnlineUsers(){
  db.collection("online").onSnapshot(s=>{
    usersEl.innerHTML="";
    s.forEach(d=>{
      const u=d.data().name;
      const div=document.createElement("div");
      div.className="user";
      div.innerHTML=`<div class="avatar">${u[0].toUpperCase()}</div>${u}<div class="online-dot"></div>`;
      usersEl.appendChild(div);
    });
  });
}

// --- TYPING ---
function listenTyping(){
  msgInput.oninput=()=>{
    db.collection("typing").doc(username).set({room:currentRoom});
    setTimeout(()=>db.collection("typing").doc(username).delete(),700);
  };
  db.collection("typing").onSnapshot(s=>{
    typingEl.innerHTML='';
    s.docs.map(d=>d.id).filter(u=>u!==username).forEach(()=>{
      const bubble=document.createElement('div');
      bubble.className='typing-bubble';
      bubble.textContent='Someone is typing...';
      typingEl.appendChild(bubble);
    });
  });
}

// --- CLEAR CHAT ---
clearBtn.onclick=async ()=>{
  const snap=await db.collection("messages").where("room","==",currentRoom).get();
  snap.forEach(d=>d.ref.delete());
};

// --- INVITE ---
inviteBtn.onclick=()=>{navigator.clipboard.writeText(location.href);alert("Invite link copied!");};

// --- CHANGE USERNAME ---
changeBtn.onclick=async ()=>{
  const newName=changeInput.value.trim();
  if(newName.length<2) return alert("Enter 2+ letters");
  await onlineRef.delete();
  await db.collection("users").doc(username).delete();
  localStorage.setItem("username",newName);
  location.reload();
};
</script>

</body>
</html>