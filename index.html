<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#eef3ff;
  --panel:#dbe6ff;
  --card:#ffffff;
  --me:#a8c7ff;
  --other:#e7edff;
  --accent:#5b7cfa;
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;height:100vh;display:flex;background:var(--bg)}

#sidebar{
  width:240px;
  background:var(--panel);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}

h2{margin:4px 0;font-weight:600}

button{
  padding:8px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.user{
  display:flex;
  align-items:center;
  gap:8px;
  background:white;
  padding:6px;
  border-radius:8px;
  margin-bottom:6px;
}

.avatar{
  width:32px;height:32px;
  border-radius:50%;
  background:var(--accent);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

#chat-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
}

#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.msg{
  max-width:70%;
  padding:10px;
  border-radius:14px;
  word-wrap:break-word;
}

.me{align-self:flex-end;background:var(--me)}
.other{align-self:flex-start;background:var(--other)}

.meta{font-size:12px;opacity:.6}

#typing{font-size:12px;font-style:italic;margin-left:12px}

form{
  display:flex;
  gap:6px;
  padding:10px;
  background:var(--panel);
}

input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:1px solid #aaa;
}

@media(max-width:768px){
  #sidebar{width:180px}
  .avatar{width:24px;height:24px;font-size:12px}
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Rooms</h2>
  <div id="rooms">
    <div class="room selected" data-room="General">General</div>
  </div>
  <input id="new-room-name" placeholder="New room name" style="padding:6px;border-radius:6px;border:1px solid #aaa;margin-bottom:6px;">
  <button id="create-room">Create Room</button>

  <h2>Online</h2>
  <div id="users"></div>
  <button id="invite">Invite Friend</button>
  <button id="clear">Clear Chat</button>
</div>

<div id="chat-wrap">
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="form">
    <input id="msg" placeholder="Messageâ€¦" autocomplete="off">
    <button>Send</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const ADMIN = "AylaAdmin";

// --- FIREBASE ---
firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});
const db = firebase.firestore();

// --- USER ---
let name = localStorage.getItem("name");
while(!name || name.trim().length<2){ name=prompt("Choose a username (2+ letters)"); }
name=name.trim();
localStorage.setItem("name",name);

// --- ONLINE ---
const userRef=db.collection("online").doc(name);
userRef.set({name});
window.addEventListener("beforeunload",()=>userRef.delete());

// --- ROOMS ---
let currentRoom="General";
const roomsEl=document.getElementById("rooms");
function joinRoom(room){
  currentRoom=room;
  document.querySelectorAll(".room").forEach(r=>r.classList.remove("selected"));
  document.querySelector(`[data-room="${room}"]`).classList.add("selected");
  listenMessages(room);
}
function listenMessages(room){
  chat.innerHTML="";
  db.collection("messages").where("room","==",room).orderBy("time")
    .onSnapshot(snapshot=>{
      chat.innerHTML="";
      snapshot.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement("div");
        div.className=`msg ${m.user===name?"me":"other"}`;
        div.innerHTML=`<div class="meta">${m.user}</div>${m.text}`;
        chat.appendChild(div);
      });
      chat.scrollTop=chat.scrollHeight;
    });
}
createRoom.addEventListener("click",()=>{
  const r=newRoomName.value.trim();
  if(!r) return;
  const div=document.createElement("div"); div.className="room"; div.dataset.room=r; div.textContent=r;
  div.addEventListener("click",()=>joinRoom(r));
  roomsEl.appendChild(div);
  newRoomName.value="";
});
joinRoom(currentRoom);

// --- SEND ---
form.onsubmit=e=>{
  e.preventDefault();
  if(!msg.value.trim())return;
  db.collection("messages").add({
    text:msg.value,
    user:name,
    room:currentRoom,
    time:Date.now()
  });
  msg.value="";
};

// --- TYPING ---
msg.oninput=()=>{
  db.collection("typing").doc(name).set({typing:true});
  setTimeout(()=>db.collection("typing").doc(name).delete(),800);
};
db.collection("typing").onSnapshot(s=>{
  typing.textContent=[...s.docs].map(d=>d.id).filter(u=>u!==name).length?"Someone is typingâ€¦":"";
});

// --- ONLINE USERS ---
db.collection("online").onSnapshot(s=>{
  users.innerHTML="";
  s.forEach(d=>{
    const u=d.data().name;
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`<div class="avatar">${u[0].toUpperCase()}</div>${u}`;
    if(name===ADMIN && u!==name){
      const btn=document.createElement("button");
      btn.textContent="â‹¯";
      btn.onclick=()=>kick(u);
      div.appendChild(btn);
    }
    users.appendChild(div);
  });
});

// --- KICK ---
function kick(u){
  if(name!==ADMIN)return;
  db.collection("kicked").doc(u).set({time:Date.now()});
}

// --- CHECK KICK ---
db.collection("kicked").doc(name).onSnapshot(d=>{
  if(d.exists) window.location.href="timeout.html"; // make a timeout.html page with your pretty picture
});

// --- INVITE ---
invite.addEventListener("click",()=>{
  navigator.clipboard.writeText(location.href);
  alert("Invite link copied ðŸ’Œ");
});

// --- CLEAR CHAT FOR EVERYONE ---
clear.addEventListener("click",()=>{
  db.collection("messages").get().then(s=>{
    s.forEach(d=>d.ref.delete());
  });
});
</script>
</body>
</html>