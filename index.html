<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* ===================== GLOBAL ===================== */
html, body { margin:0; padding:0; height:100%; font-family:"Georgia", sans-serif; background:#1e1b2d; color:#dcd6f7; display:flex; flex-direction:column; }
header { padding:12px 20px; background:#4b3b77; display:flex; justify-content:space-between; align-items:center; font-size:1.1rem; }
header span { opacity:0.85; }
input, button { font-family:inherit; font-size:1rem; }

/* ===================== MAIN LAYOUT ===================== */
#main { flex:1; display:flex; overflow:hidden; }
#sidebar { width:200px; background:#3a2e66; padding:10px; display:flex; flex-direction:column; gap:10px; overflow-y:auto; }
#chatContainer { flex:1; display:flex; flex-direction:column; }
#chat { flex:1; overflow-y:auto; padding:12px 16px; scrollbar-width: thin; scrollbar-color:#7fa1ff #2b2244; background:#2b2244; }
#chat::-webkit-scrollbar { width:8px; }
#chat::-webkit-scrollbar-thumb { background-color:#7fa1ff; border-radius:4px; }

/* ===================== MESSAGES ===================== */
.msg { margin-bottom:10px; padding:8px 12px; border-radius:6px; max-width:85%; word-wrap:break-word; color:#e0d9ff; display:flex; align-items:flex-end; gap:6px; }
.me { background:#5a7fff; margin-left:auto; color:#fff; }
.meta { font-size:0.75rem; opacity:0.7; }
.text { font-size:1rem; }
.avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; }

/* ===================== FORM ===================== */
#form { display:flex; padding:10px 16px; background:#4b3b77; gap:8px; align-items:center; }
#message { flex:1; padding:10px; border-radius:4px; border:1px solid #6658a8; background:#2b2244; color:#e0d9ff; }
button { padding:8px 12px; border:none; border-radius:4px; background:#7fa1ff; color:#111b33; font-weight:bold; cursor:pointer; }
button:disabled { opacity:0.5; cursor:default; }

/* ===================== ONLINE USERS ===================== */
.onlineUser { display:flex; align-items:center; gap:6px; padding:4px; background:#4b3b77; border-radius:4px; cursor:pointer; }

/* ===================== TYPING INDICATOR ===================== */
.typing { font-style:italic; opacity:0.7; margin-left:36px; }
</style>
</head>
<body>
<header>
  <div><strong>Class Chat</strong></div>
  <div>
    <span>Name:</span>
    <input id="username" placeholder="you">
  </div>
</header>

<div id="main">
  <div id="sidebar">
    <strong>Rooms</strong>
    <select id="roomSelect">
      <option value="general">General</option>
    </select>
    <button id="createRoom">Create Private Room</button>
    <strong>Online</strong>
    <div id="onlineUsers"></div>
  </div>

  <div id="chatContainer">
    <div id="chat"></div>
    <form id="form">
      <input id="message" autocomplete="off" placeholder="Type a message...">
      <button id="send" type="submit">Send</button>
      <button type="button" id="clear">Clear Chat</button>
      <button type="button" id="muteBtn">Mute</button>
    </form>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // ===================== CONFIG =====================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ===================== STATE =====================
  const chatEl = document.getElementById("chat");
  const formEl = document.getElementById("form");
  const msgInput = document.getElementById("message");
  const userInput = document.getElementById("username");
  const roomSelect = document.getElementById("roomSelect");
  const createRoomBtn = document.getElementById("createRoom");
  const onlineDiv = document.getElementById("onlineUsers");
  const clearBtn = document.getElementById("clear");
  const muteBtn = document.getElementById("muteBtn");
  let currentRoom = "general";
  let typingUsers = {};
  let muted = false;
  const KICK_PASSWORD = "slay";

  // ===================== HELPERS =====================
  function addMessage(msg){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (msg.name===userInput.value.trim() ? " me" : "");
    const avatar = document.createElement("img");
    avatar.className = "avatar";
    avatar.src = msg.avatar||"https://i.pravatar.cc/32?img=1";
    const meta = document.createElement("div");
    meta.className="meta";
    meta.textContent = msg.name + " â€¢ " + new Date(msg.time).toLocaleTimeString();
    const text = document.createElement("div");
    text.className="text";
    text.textContent = msg.text;
    wrap.appendChild(avatar);
    wrap.appendChild(meta);
    wrap.appendChild(text);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function updateOnline(users){
    onlineDiv.innerHTML="";
    users.forEach(u=>{
      const div = document.createElement("div");
      div.className="onlineUser";
      const avatar = document.createElement("img");
      avatar.src = u.avatar||"https://i.pravatar.cc/32?img=1";
      avatar.className="avatar";
      div.appendChild(avatar);
      div.appendChild(document.createTextNode(u.name));
      div.onclick=()=>{
        const pass = prompt("Kick user? Enter kick password:");
        if(pass===KICK_PASSWORD && u.name!==userInput.value.trim()){
          // Move user to timeout room
          db.collection("users").doc(u.id).update({room:"timeout"});
        }
      }
      onlineDiv.appendChild(div);
    });
  }

  // ===================== ROOMS =====================
  createRoomBtn.onclick=()=>{
    const roomName = prompt("Enter new private room name:");
    if(roomName) {
      if(![...roomSelect.options].some(o=>o.value===roomName)){
        const opt = document.createElement("option");
        opt.value=roomName;
        opt.textContent=roomName;
        roomSelect.appendChild(opt);
      }
      roomSelect.value = roomName;
      currentRoom = roomName;
      loadMessages();
    }
  }

  roomSelect.onchange=()=>{
    currentRoom=roomSelect.value;
    loadMessages();
  }

  // ===================== USERS =====================
  const userId = Math.random().toString(36).substring(2,10);
  const userRef = db.collection("users").doc(userId);
  function goOnline(){
    userRef.set({
      name: userInput.value.trim()||"anon",
      room: currentRoom,
      avatar:"https://i.pravatar.cc/32?img="+Math.floor(Math.random()*70)
    });
  }
  setInterval(goOnline,5000);

  db.collection("users").where("room","==",currentRoom)
    .onSnapshot(snap=>{
      const users=[];
      snap.forEach(d=>users.push({...d.data(),id:d.id}));
      updateOnline(users);
    });

  // ===================== CHAT =====================
  function loadMessages(){
    db.collection("messages").where("room","==",currentRoom)
      .orderBy("time").onSnapshot(snap=>{
        chatEl.innerHTML="";
        snap.forEach(d=>{
          addMessage(d.data());
        });
      });
  }
  loadMessages();

  formEl.onsubmit=e=>{
    e.preventDefault();
    if(muted) return;
    const msg = {
      name:userInput.value.trim()||"anon",
      text:msgInput.value,
      time:Date.now(),
      avatar:"https://i.pravatar.cc/32?img="+Math.floor(Math.random()*70),
      room:currentRoom
    };
    db.collection("messages").add(msg);
    msgInput.value="";
  }

  clearBtn.onclick=()=>{ chatEl.innerHTML=""; }

  muteBtn.onclick=()=>{ muted=!muted; muteBtn.textContent = muted?"Unmute":"Mute"; }

  // ===================== TIMEOUT ROOM =====================
  db.collection("users").doc(userId).onSnapshot(doc=>{
    if(doc.data()?.room==="timeout"){
      document.body.innerHTML='<div style="background: url(https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80) no-repeat center center / cover; height:100%; display:flex; justify-content:center; align-items:center;"><h1 style="color:white; font-size:2rem;">Timeout Room</h1></div>';
    }
  });

</script>
</body>
</html>