<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#eef3ff;
  --panel:#dbe6ff;
  --card:#ffffff;
  --me:#a8c7ff;
  --other:#e7edff;
  --accent:#5b7cfa;
}

*{box-sizing:border-box;font-family:Inter}
body{margin:0;height:100vh;display:flex;background:var(--bg)}

#sidebar{
  width:240px;
  background:var(--panel);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

h2{margin:4px 0}

button{
  padding:8px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.user{
  display:flex;
  align-items:center;
  gap:8px;
  background:white;
  padding:6px;
  border-radius:8px;
  margin-bottom:6px;
}

.avatar{
  width:32px;height:32px;
  border-radius:50%;
  background:var(--accent);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

#chat-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
}

#chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.msg{
  max-width:70%;
  padding:10px;
  border-radius:14px;
}

.me{align-self:flex-end;background:var(--me)}
.other{align-self:flex-start;background:var(--other)}

.meta{font-size:12px;opacity:.6}

#typing{font-size:12px;font-style:italic;margin-left:12px}

form{
  display:flex;
  gap:6px;
  padding:10px;
  background:var(--panel);
}

input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:1px solid #aaa;
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Online</h2>
  <div id="users"></div>
  <button onclick="invite()">Invite Friend</button>
  <button onclick="clearChat()">Clear Chat</button>
</div>

<div id="chat-wrap">
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="form">
    <input id="msg" placeholder="Message‚Ä¶" autocomplete="off">
    <button>Send</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* üîê CONFIG */
const ADMIN = "AylaAdmin";

firebase.initializeApp({
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3"
});

const db = firebase.firestore();

/* üë§ USERNAME (NO ANON) */
let name = localStorage.getItem("name");
while(!name || name.trim().length < 2){
  name = prompt("Choose a username (2+ letters)");
}
name = name.trim();
localStorage.setItem("name",name);

/* üö® KICK CHECK */
db.collection("kicked").doc(name).onSnapshot(d=>{
  if(d.exists) location.reload();
});

/* üü¢ ONLINE */
const userRef=db.collection("online").doc(name);
userRef.set({name});
window.addEventListener("beforeunload",()=>userRef.delete());

db.collection("online").onSnapshot(s=>{
  users.innerHTML="";
  s.forEach(d=>{
    const u=d.data().name;
    const div=document.createElement("div");
    div.className="user";
    div.innerHTML=`
      <div class="avatar">${u[0].toUpperCase()}</div>
      ${u}
      ${name===ADMIN && u!==name ? `<button onclick="kick('${u}')">‚ãØ</button>`:""}
    `;
    users.appendChild(div);
  });
});

/* üí¨ CHAT */
form.onsubmit=e=>{
  e.preventDefault();
  if(!msg.value.trim())return;
  db.collection("messages").add({
    user:name,
    text:msg.value,
    time:Date.now()
  });
  msg.value="";
};

db.collection("messages").orderBy("time").onSnapshot(s=>{
  chat.innerHTML="";
  s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className=`msg ${m.user===name?"me":"other"}`;
    div.innerHTML=`<div class="meta">${m.user}</div>${m.text}`;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
});

/* ‚úçÔ∏è TYPING */
msg.oninput=()=>{
  db.collection("typing").doc(name).set({typing:true});
  setTimeout(()=>db.collection("typing").doc(name).delete(),800);
};

db.collection("typing").onSnapshot(s=>{
  typing.textContent=[...s.docs].map(d=>d.id).filter(u=>u!==name).length
    ? "Someone is typing‚Ä¶"
    : "";
});

/* üö™ ADMIN KICK */
function kick(u){
  if(name!==ADMIN)return;
  db.collection("kicked").doc(u).set({time:Date.now()});
}

/* üîó INVITE */
function invite(){
  navigator.clipboard.writeText(location.href);
  alert("Invite link copied üíå");
}

/* üßπ CLEAR */
function clearChat(){
  if(name!==ADMIN)return;
  db.collection("messages").get().then(s=>{
    s.forEach(d=>d.ref.delete());
  });
}
</script>
</body>
</html>