<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Class Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#eef3ff;
  --panel:#dbe6ff;
  --chat-bg:#ffffff;
  --my-msg:#a8c7ff;
  --other-msg:#e7edff;
  --accent:#5b7cfa;
  --text:#1b1b1b;
  --meta:#555;
}

*{margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif;}

body{display:flex; height:100vh; background:var(--bg); color:var(--text);}

#sidebar{
  width:250px; background:var(--panel); padding:12px; display:flex; flex-direction:column; gap:12px; overflow-y:auto;
}
#sidebar h2{margin-bottom:6px;}
.room, .user{
  display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-radius:6px; cursor:pointer; background:#cfe0f5; margin-bottom:6px;
}
.room.selected, .user.selected{background:var(--accent); color:#fff;}
.room:hover, .user:hover{background:#b0c9eb;}
.avatar{
  width:32px; height:32px; border-radius:50%; background:var(--accent); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; margin-right:6px; flex-shrink:0;
}
#chat-wrap{flex:1; display:flex; flex-direction:column; background:var(--chat-bg);}
#chat{flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:6px;}
.msg{max-width:70%; padding:10px; border-radius:14px; position:relative; word-wrap:break-word;}
.me{align-self:flex-end; background:var(--my-msg);}
.other{align-self:flex-start; background:var(--other-msg);}
.meta{font-size:12px; opacity:.6; margin-bottom:2px;}
.typing{font-size:12px; font-style:italic; color:#888; margin-left:4px;}
form{display:flex; gap:6px; padding:10px; background:var(--panel);}
input{flex:1; padding:10px; border-radius:8px; border:1px solid #aaa;}
button{padding:8px 12px; border:none; border-radius:8px; background:var(--accent); color:white; font-weight:600; cursor:pointer;}
button:disabled{opacity:0.5; cursor:default;}

@media(max-width:768px){
  #sidebar{width:180px; font-size:0.9rem;}
  .avatar{width:24px; height:24px;}
  input{font-size:0.9rem;}
  button{font-size:0.9rem; padding:6px 10px;}
}
</style>
</head>
<body>

<div id="sidebar">
  <h2>Rooms</h2>
  <div id="rooms"></div>
  <input id="new-room-name" placeholder="New room name">
  <input id="new-room-pass" placeholder="Optional password">
  <button id="create-room">Create Room</button>

  <h2>Online Users</h2>
  <div id="users"></div>
  <button id="invite-btn">Invite Friend</button>
  <button id="clear-btn">Clear Chat</button>
</div>

<div id="chat-wrap">
  <div id="chat"></div>
  <div id="typing"></div>
  <form id="chat-form">
    <input id="msg" placeholder="Type a message‚Ä¶" autocomplete="off">
    <button>Send</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// üîê CONFIG
firebase.initializeApp({
  apiKey:"AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain:"live-chat-3d2c3.firebaseapp.com",
  projectId:"live-chat-3d2c3"
});
const db = firebase.firestore();

// üë§ USER
let username = localStorage.getItem("username");
while(!username || username.trim().length<2){
  username = prompt("Choose a username (2+ letters):").trim();
}
localStorage.setItem("username", username);

// üåê ONLINE USERS
const usersEl = document.getElementById("users");
const onlineRef = db.collection("online").doc(username);
onlineRef.set({name:username});
window.addEventListener("beforeunload", ()=>onlineRef.delete());
db.collection("online").onSnapshot(snapshot=>{
  usersEl.innerHTML="";
  snapshot.forEach(doc=>{
    const u = doc.data().name;
    const div = document.createElement("div");
    div.className="user";
    div.innerHTML = `<div class="avatar">${u[0].toUpperCase()}</div>${u}`;
    usersEl.appendChild(div);
  });
});

// üí¨ ROOMS
const roomsEl = document.getElementById("rooms");
let currentRoom = "General";

function addRoom(name){
  const div = document.createElement("div");
  div.className = "room";
  div.textContent = name;
  div.addEventListener("click", ()=>joinRoom(name));
  roomsEl.appendChild(div);
}
function joinRoom(name){
  currentRoom=name;
  document.querySelectorAll(".room").forEach(r=>r.classList.remove("selected"));
  [...roomsEl.children].forEach(r=>{if(r.textContent===name) r.classList.add("selected")});
  listenMessages();
}
addRoom("General");
joinRoom("General");

document.getElementById("create-room").addEventListener("click", ()=>{
  const rName=document.getElementById("new-room-name").value.trim();
  const rPass=document.getElementById("new-room-pass").value.trim();
  if(!rName) return;
  db.collection("rooms").doc(rName).set({password:rPass});
  addRoom(rName);
  document.getElementById("new-room-name").value="";
  document.getElementById("new-room-pass").value="";
});

// üí¨ MESSAGES
const chatEl = document.getElementById("chat");
const msgInput = document.getElementById("msg");
document.getElementById("chat-form").addEventListener("submit", e=>{
  e.preventDefault();
  if(!msgInput.value.trim()) return;
  db.collection("messages").add({
    user:username,
    text:msgInput.value,
    room:currentRoom,
    time:Date.now()
  });
  msgInput.value="";
});

// Listen messages per room
function listenMessages(){
  db.collection("messages").where("room","==",currentRoom).orderBy("time")
  .onSnapshot(snapshot=>{
    chatEl.innerHTML="";
    snapshot.forEach(doc=>{
      const m=doc.data();
      const div=document.createElement("div");
      div.className = "msg " + (m.user===username?"me":"other");
      div.innerHTML=`<div class="meta">${m.user}</div>${m.text}`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}
listenMessages();

// ‚úçÔ∏è TYPING
msgInput.oninput=()=>{
  db.collection("typing").doc(username).set({typing:true});
  setTimeout(()=>db.collection("typing").doc(username).delete(),1000);
};
db.collection("typing").onSnapshot(s=>{
  const typingUsers=[...s.docs].map(d=>d.id).filter(u=>u!==username);
  document.getElementById("typing").textContent=typingUsers.length?"Someone is typing‚Ä¶":"";
});

// üßπ CLEAR
document.getElementById("clear-btn").addEventListener("click",()=>{
  db.collection("messages").where("room","==",currentRoom).get()
    .then(s=>s.forEach(d=>d.ref.delete()));
});

// üîó INVITE
document.getElementById("invite-btn").addEventListener("click",()=>{
  navigator.clipboard.writeText(location.href);
  alert("Invite link copied üíå");
});
</script>
</body>
</html>