<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class Chat Rooms</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body {
  margin:0; padding:0; height:100%;
  font-family:"Georgia", sans-serif;
  background:#1e1b2d; color:#dcd6f7;
  display:flex; flex-direction:column;
}

/* HEADER */
header {
  padding:16px;
  background:#4b3b77;
  display:flex;
  gap:12px;
  align-items:center;
}

input, select {
  font-size:1.2rem;
  padding:10px;
  background:#2b2244;
  border:1px solid #6658a8;
  color:#e0d9ff;
  border-radius:6px;
}

/* CHAT */
#chat {
  flex:1;
  overflow-y:auto;
  padding:16px;
  font-size:1.2rem;
}

.msg {
  margin-bottom:12px;
  padding:12px;
  border-radius:8px;
  background:#3a2e66;
  max-width:85%;
}

.me {
  background:#5a7fff;
  margin-left:auto;
  color:white;
}

.meta {
  font-size:0.9rem;
  opacity:0.7;
  margin-bottom:4px;
}

/* FORM */
#form {
  display:flex;
  gap:10px;
  padding:14px;
  background:#4b3b77;
}

#message {
  flex:1;
  font-size:1.2rem;
  padding:12px;
  border-radius:6px;
  border:1px solid #6658a8;
  background:#2b2244;
  color:#e0d9ff;
}

button {
  font-size:1.2rem;
  padding:12px 18px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

#send { background:#7fa1ff; }
#clear { background:#ff7fa1; }
</style>
</head>

<body>

<header>
  <input id="username" placeholder="your name">
  <select id="room">
    <option value="general">General</option>
    <option value="homework">Homework</option>
    <option value="random">Random</option>
    <option value="private">Private</option>
  </select>
</header>

<div id="chat"></div>

<form id="form">
  <input id="message" placeholder="Type a message..." autocomplete="off">
  <button id="send" type="submit">Send</button>
  <button id="clear" type="button">Clear</button>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9GQMi0v4ItnkJ2uqKtUUQU59DorLrCAg",
  authDomain: "live-chat-3d2c3.firebaseapp.com",
  projectId: "live-chat-3d2c3",
  storageBucket: "live-chat-3d2c3.firebasestorage.app",
  messagingSenderId: "550798266942",
  appId: "1:550798266942:web:2ce678f70e4f64d6f7376f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const chatEl = document.getElementById("chat");
const form = document.getElementById("form");
const msgInput = document.getElementById("message");
const userInput = document.getElementById("username");
const roomSelect = document.getElementById("room");
const clearBtn = document.getElementById("clear");

const TEACHER_PASSWORD = "Baddie";

/* SAVE USERNAME */
userInput.value = localStorage.getItem("username") || "";
userInput.addEventListener("input", () =>
  localStorage.setItem("username", userInput.value)
);

let unsubscribe = null;

/* ADD MESSAGE */
function addMessage(msg, me){
  const div = document.createElement("div");
  div.className = "msg" + (me ? " me" : "");
  div.innerHTML = `
    <div class="meta">${msg.name} â€¢ ${new Date(msg.time).toLocaleTimeString()}</div>
    ${msg.text}
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* LOAD ROOM */
async function loadRoom(){
  chatEl.innerHTML = "";
  if(unsubscribe) unsubscribe();

  const room = roomSelect.value;

  // ðŸ” PRIVATE ROOM PASSWORD
  if(room === "private"){
    const doc = await db.collection("roomPasswords").doc("private").get();

    if(!doc.exists){
      const newPass = prompt("Create a password for this private room:");
      if(!newPass) {
        roomSelect.value = "general";
        return loadRoom();
      }
      await db.collection("roomPasswords").doc("private").set({ password:newPass });
      alert("Private room created!");
    } else {
      const input = prompt("Enter private room password:");
      if(input !== doc.data().password){
        alert("Wrong password");
        roomSelect.value = "general";
        return loadRoom();
      }
    }
  }

  unsubscribe = db.collection("messages")
    .where("room","==",room)
    .orderBy("time")
    .onSnapshot(snapshot=>{
      chatEl.innerHTML="";
      snapshot.forEach(doc=>{
        const msg = doc.data();
        addMessage(msg, msg.name === userInput.value);
      });
    });
}

roomSelect.addEventListener("change", loadRoom);
loadRoom();

/* SEND MESSAGE */
form.addEventListener("submit", e=>{
  e.preventDefault();
  if(!msgInput.value.trim()) return;

  db.collection("messages").add({
    name: userInput.value || "anon",
    text: msgInput.value,
    room: roomSelect.value,
    time: Date.now()
  });

  msgInput.value="";
});

/* CLEAR ROOM */
clearBtn.addEventListener("click", ()=>{
  const pass = prompt("Teacher password:");
  if(pass !== TEACHER_PASSWORD) return alert("Wrong password");

  db.collection("messages")
    .where("room","==",roomSelect.value)
    .get()
    .then(snap => snap.forEach(doc => doc.ref.delete()));
});
</script>

</body>
</html>